namespace Library
open System
open Helpers

[<SolutionModule>]
module Problem13 =

    let solution () =
        printfn "Starting solver"
        let timer = System.Diagnostics.Stopwatch.StartNew()

        printfn "The n'th triangle number is given by the sum of one to n (Euler's formula n(n+1)/2)"
        printfn "n and n+1 are co prime so their prime factors are mutually exclusive e.g."
        printfn "20 = 2^2 * 5^1"
        printfn "21 = 3^1 * 7^1"
        printfn "In general we have "
        printfn "n = p0 ^ i0 * p1 ^ i1 ... pk ^ ik "
        printfn "n+1 = q0 ^ j0 * q1 ^ j1 ... ql ^ jl "
        printfn "Then, triangle(n) = p0 ^ i0 ... * pk ^ ik * q0 ^ j0 * ... * ql ^ jl ... divided by 2"
        printfn "The number of divisors is given by the unique permutations of prime factors:"
        printfn "(i0 + 1) * (i1 + 1) * ... * (jl + 1) - with the exception that the power of 2 is reduced by 1"
        printfn "We want to find the n'th triangle number such that this gives 500 or more divisors"
        printfn "500 = 2^2  * 5^3 so we want the triangle number to look like e.g. 2^4 * 3^4 * 5^4 * 7^1 * 11^1"

        let minAttempt = (pown 2 4) * (pown 3 4)
        
        printfn "We will start from n = %i ... find the prime factors of n and of (n+1) ... then calculate the number of divisors" minAttempt
        
        let ans = 
            seq { minAttempt .. (minAttempt + 12000) }
            |> Seq.map (fun s ->
                (sumOfOneTo s, countTriangleDivisors (int64 s))
            )
            |> Seq.filter (fun (s, c) -> c >= 500L)
            |> List.ofSeq
            |> List.minBy (fun (s, c) -> s)
            |> fst
            |> string
            
        let elapsed = timer.ElapsedMilliseconds
        printfn "Answer: %s Elapsed : %i ms" ans elapsed 

        ans |> string

    [<Solution(13)>]
    let problem () = {
        Title = "Highly divisible triangular number"
        Description = "
The sequence of triangle numbers is generated by adding the natural numbers. So the 7th triangle number would be 1 + 2 + 3 + 4 + 5 + 6 + 7 = 28. The first ten terms would be:

1, 3, 6, 10, 15, 21, 28, 36, 45, 55, ...

Let us list the factors of the first seven triangle numbers:

 1: 1
 3: 1,3
 6: 1,2,3,6
10: 1,2,5,10
15: 1,3,5,15
21: 1,3,7,21
28: 1,2,4,7,14,28

We can see that 28 is the first triangle number to have over five divisors.

What is the value of the first triangle number to have over five hundred divisors?"
        Solution = solution }